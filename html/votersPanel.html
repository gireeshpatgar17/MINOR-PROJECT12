<!-- voters_panel.html  -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voters Panel</title>
    <link rel="stylesheet" href="/css/candidates_panel.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
      window.__importSupabase = async () =>
        (await import("https://esm.sh/@supabase/supabase-js@2")).createClient;
    </script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      const SUPABASE_URL = "https://ogbykbxfralllvyukpuk.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nYnlrYnhmcmFsbGx2eXVrcHVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDYzNzIsImV4cCI6MjA3NjA4MjM3Mn0.mKnh40g6I7-hBlmvtcAuSzUc9WJWDmgMdKCQnY2UKKE";

      function Header() {
        return (
          <header>
            <div>
              <strong>Voters Panel</strong>
              <div className="muted">Manage voters</div>
            </div>
            <div>
              <button className="btn" onClick={() => (window.location.href = "admin.html")}>
                Back to Admin
              </button>
            </div>
          </header>
        );
      }

      function Form({ value, onChange, onSubmit, onCancel, saving }) {
        return (
          <div className="card">
            <div className="row">
              <div style={{ flex: 1 }}>
                <label>Aadhaar No</label>
                <input
                  value={value.aadhaar_no}
                  onChange={(e) => onChange({ ...value, aadhaar_no: e.target.value })}
                  placeholder="12 digits"
                />
              </div>
              <div style={{ flex: 1 }}>
                <label>Name</label>
                <input
                  value={value.name}
                  onChange={(e) => onChange({ ...value, name: e.target.value })}
                />
              </div>
            </div>

            <div className="row">
              <div style={{ flex: 1 }}>
                <label>Mobile No</label>
                <input
                  value={value.mobile_no}
                  onChange={(e) => onChange({ ...value, mobile_no: e.target.value })}
                  placeholder="10 digits"
                />
              </div>
            </div>

            <div className="row">
              <div style={{ flex: 1 }}>
                <label>Date of Birth</label>
                <input
                  type="date"
                  value={value.dob || ""}
                  onChange={(e) => onChange({ ...value, dob: e.target.value })}
                />
              </div>
              <div style={{ flex: 1 }}>
                <label>Email</label>
                <input
                  type="email"
                  value={value.email || ""}
                  onChange={(e) => onChange({ ...value, email: e.target.value })}
                  placeholder="name@example.com"
                />
              </div>
            </div>

            <div className="row">
              <button className="btn" onClick={onCancel}>Cancel</button>
              <button className="btn" onClick={onSubmit} disabled={saving}>
                {saving ? "Saving…" : "Save"}
              </button>
            </div>
          </div>
        );
      }

      function Panel() {
        const [list, setList] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [editing, setEditing] = React.useState(null);

        const [draft, setDraft] = React.useState({
          id: null,
          aadhaar_no: "",
          name: "",
          mobile_no: "",
          dob: "",
          email: "",
          has_voted: false,
        });

        const client = React.useMemo(
          () => ({
            create: async () => {
              const createClient = await window.__importSupabase();
              return createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            },
          }),
          []
        );

        const validate = async (v, id) => {
          if (!/^[0-9]{12}$/.test(v.aadhaar_no)) return "Aadhaar must be 12 digits";
          if (!v.name) return "Name is required";
          if (!/^[0-9]{10}$/.test(v.mobile_no)) return "Mobile must be 10 digits";
          if (!v.dob) return "Date of Birth is required";
          if (!v.email) return "Email is required";
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.email)) return "Invalid email";

          const supabase = await client.create();
          const checks = [["aadhaar_no", v.aadhaar_no]];

          for (const pair of checks) {
            const col = pair[0];
            const val = pair[1];
            let q = supabase.from("voters").select("id").eq(col, val).limit(1);
            if (id) q = q.neq("id", id);
            const { data, error } = await q;
            if (error) return error.message;
            if (data && data.length > 0) return `${col} already exists`;
          }

          return null;
        };

        const load = React.useCallback(async () => {
          setLoading(true);
          setError(null);

          try {
            const supabase = await client.create();
            const { data, error } = await supabase
              .from("voters")
              .select("*")
              .order("created_at", { ascending: false });

            if (error) throw error;

            setList(data || []);
          } catch (err) {
            setError(err.message || "Failed to load voters");
          } finally {
            setLoading(false);
          }
        }, [client]);

        React.useEffect(() => {
          load();
        }, [load]);

        const onSubmit = async () => {
          const id = draft.id;
          const err = await validate(draft, id);
          if (err) return alert(err);

          setLoading(true);
          try {
            const supabase = await client.create();

            if (id) {
              await supabase.from("voters").update({
                aadhaar_no: draft.aadhaar_no,
                name: draft.name,
                mobile_no: draft.mobile_no,
                dob: draft.dob,
                email: draft.email,
              }).eq("id", id);
            } else {
              await supabase.from("voters").insert({
                aadhaar_no: draft.aadhaar_no,
                name: draft.name,
                mobile_no: draft.mobile_no,
                dob: draft.dob,
                email: draft.email,
                has_voted: false
              });
            }

            setDraft({
              id: null,
              aadhaar_no: "",
              name: "",
              mobile_no: "",
              dob: "",
              email: "",
              has_voted: false,
            });

            setEditing(false);
            await load();
          } catch (err) {
            alert(err.message || "Failed to save voter");
          } finally {
            setLoading(false);
          }
        };

        const onEdit = (v) => {
          setEditing(true);
          setDraft({
            id: v.id,
            aadhaar_no: v.aadhaar_no,
            name: v.name,
            mobile_no: v.mobile_no,
            dob: v.dob || "",
            email: v.email,
            has_voted: v.has_voted,
          });
        };

        const onDelete = async (v) => {
          if (!confirm("Remove this voter?")) return;

          setLoading(true);
          try {
            const supabase = await client.create();
            await supabase.from("voters").delete().eq("id", v.id);
            await load();
          } catch (err) {
            alert(err.message || "Failed to remove the voter");
          } finally {
            setLoading(false);
          }
        };

        return (
          <>
            <Header />

            <div className="container">
              <Form
                value={draft}
                onChange={setDraft}
                onSubmit={onSubmit}
                onCancel={() =>
                  setDraft({
                    id: null,
                    aadhaar_no: "",
                    name: "",
                    mobile_no: "",
                    dob: "",
                    email: "",
                    has_voted: false,
                  })
                }
                saving={loading}
              />

              <div className="card">
                <div style={{ display: "flex", justifyContent: "space-between" }}>
                  <h3>Voters</h3>
                  <button className="btn" onClick={load} disabled={loading}>
                    Refresh
                  </button>
                </div>

                {loading && <div className="muted">Loading…</div>}
                {error && <div className="muted">{error}</div>}

                <div style={{ overflowX: "auto" }}>
                  <table>
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>DOB</th>
                        <th>Email</th>
                        <th>Is Registered</th>
                        <th>Actions</th>
                      </tr>
                    </thead>

                    <tbody>
                      {list.map((v) => {
                        const is_registered =
                          v.is_registered === true ||
                          v.is_registered === "true" ||
                          v.is_registered === 1;

                        return (
                          <tr key={v.id}>
                            <td>{v.name}</td>
                            <td>{v.dob || "-"}</td>
                            <td>{v.email || "-"}</td>
                            <td>{is_registered ? "Yes" : "No"}</td>

                            <td>
                              <button className="btn" onClick={() => onEdit(v)}>
                                Edit
                              </button>
                              <button className="btn" onClick={() => onDelete(v)}>
                                Remove
                              </button>
                            </td>
                          </tr>
                        );
                      })}

                      {!loading && list.length === 0 && (
                        <tr>
                          <td colSpan={5} className="muted">
                            No voters found.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Panel />);
    </script>
  </body>
</html>
